<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f1f5f9">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%232563eb'/%3E%3Cstop offset='100%25' stop-color='%2316a34a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23g)'/%3E%3Ctext x='50' y='65' font-size='50' font-family='Arial, sans-serif' font-weight='bold' fill='white' text-anchor='middle'%3EP%3C/text%3E%3C/svg%3E">
    
    <title>PaceBudget</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-sub: #64748b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 15px;
            padding-bottom: 100px;
            color: var(--text-main);
        }

        .container { max-width: 900px; margin: 0 auto; }

        /* --- HEADER --- */
        header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }

        .user-area { display: flex; align-items: center; gap: 10px; }
        .user-name-display { font-weight: 600; color: var(--text-main); font-size: 0.9rem; text-align: right;}

        .profile-btn {
            background: #e2e8f0; color: var(--text-main); 
            width: 40px; height: 40px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background 0.2s;
        }
        .profile-btn:hover { background: #cbd5e1; }

        .controls {
            background: var(--surface); padding: 15px; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* Nav Layout */
        .month-nav { display: flex; align-items: center; gap: 10px; justify-content: center; width: 100%; }
        .month-nav h2 { margin: 0; font-size: 1.1rem; min-width: 130px; text-align: center; }
        
        .jump-today { 
            font-size: 0.8rem; color: var(--primary); cursor: pointer; text-decoration: underline; 
            margin-left: 5px; white-space: nowrap;
        }

        .budget-row { display: flex; align-items: center; gap: 10px; font-weight: 500; }
        
        .month-summary {
            font-size: 0.85rem; color: var(--text-sub); background: #f8fafc;
            padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #e2e8f0;
        }

        .top-actions { display: flex; gap: 10px; flex-wrap: wrap; }

        /* --- BUTTONS & INPUTS --- */
        button {
            background: var(--primary); color: white; border: none; padding: 10px 16px;
            border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; transform: scale(0.98); }
        
        button.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        button.btn-outline:hover { background: #f1f5f9; border-color: #cbd5e1; }
        
        button.btn-text { background: transparent; color: var(--text-sub); padding: 5px; }
        button.btn-text:hover { color: var(--text-main); }
        
        button.btn-success { background: var(--success); }
        
        button.btn-danger-outline { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        button.btn-danger-outline:hover { background: #fef2f2; }
        
        button.btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        
        button.action-btn { 
            background: #f1f5f9; color: var(--text-main); font-weight: 500; 
            font-size: 0.8rem; padding: 5px 10px; border: 1px solid var(--border);
        }

        input[type="text"], input[type="number"], input[type="email"], input[type="password"], input[type="url"], input[type="date"] {
            padding: 10px; border: 1px solid var(--border); border-radius: 8px;
            font-size: 1rem; background: #fff; width: 100%;
        }
        
        .checkbox-wrapper {
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--text-sub);
            margin-top: 5px; cursor: pointer;
        }
        input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }

        /* --- INBOX / UNSCHEDULED DRAWER --- */
        #inboxBtn { width: 100%; text-align: left; justify-content: space-between; flex-grow: 1; }

        .pending-drawer {
            background: var(--surface); border-radius: 12px; margin-bottom: 20px;
            overflow: hidden; display: none; border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .pending-drawer.open { display: block; }

        .pending-input-area {
            padding: 15px; background: #f8fafc; border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px;
        }
        
        .pending-row-main { display: flex; gap: 8px; }
        #pendingAmount { width: 90px; flex-shrink: 0; }
        #pendingDesc { flex-grow: 1; }
        
        .link-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .link-input { font-size: 0.85rem; padding: 8px; color: var(--primary); flex-grow: 1; }

        .pending-list { padding: 0; max-height: 400px; overflow-y: auto; }

        .pending-item {
            padding: 15px; border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px;
        }
        .pending-item.editing { background-color: #fffbeb; border-left: 3px solid var(--warning); }

        .pending-top { display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 1rem; }
        
        .pending-actions { 
            display: flex; justify-content: space-between; align-items: center; 
            padding-top: 5px; gap: 10px; flex-wrap: wrap;
        }
        .pending-edit-controls { display: flex; gap: 5px; }

        .schedule-row {
            display: flex; align-items: center; gap: 5px; background: #f8fafc; 
            padding: 5px; border-radius: 6px; border: 1px solid #e2e8f0;
        }
        .manual-date-input {
            padding: 4px; font-size: 0.8rem; width: 110px; border: 1px solid #ccc;
        }

        /* --- CALENDAR GRID --- */
        .calendar-header {
            display: grid; grid-template-columns: repeat(7, 1fr); text-align: center;
            font-weight: bold; color: var(--text-sub); margin-bottom: 8px; font-size: 0.85rem;
        }

        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px;
            background-color: var(--border); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
        }

        .day-cell {
            background-color: var(--surface); min-height: 110px; padding: 8px;
            display: flex; flex-direction: column; cursor: pointer;
        }
        .day-cell:hover { background-color: #f8fafc; }
        .day-cell.today { background-color: #eff6ff; }
        .day-cell.hidden-mobile { display: flex; }
        
        .date-number { font-weight: 700; display: flex; justify-content: space-between; margin-bottom: 5px; }
        .day-weekday { display: none; }
        
        .expense-chips { display: flex; flex-direction: column; gap: 2px; flex-grow: 1; }
        
        /* Updated Chip Style: Truncation logic - NO ICONS */
        .expense-chip { 
            font-size: 0.75rem; color: var(--text-sub); 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            display: block; 
            background: #f1f5f9; padding: 2px 6px; border-radius: 4px;
        }
        .chip-desc-text { opacity: 0.9; margin-left: 0; font-weight: normal; }

        .balance-indicator { font-size: 0.8rem; font-weight: 700; text-align: right; margin-top: auto; }
        .bal-pos { color: var(--success); }
        .bal-neg { color: var(--danger); }

        #historyToggleContainer { text-align: center; margin-bottom: 10px; display: none; }
        .history-btn { background: #e2e8f0; color: var(--text-sub); font-size: 0.8rem; border-radius: 20px; padding: 6px 16px; }

        /* --- TOAST NOTIFICATIONS --- */
        #toast-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 10px; z-index: 3000;
            width: 90%; max-width: 400px; pointer-events: none;
        }
        .toast {
            background: #333; color: white; padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 0.9rem; text-align: center;
            animation: fadeUp 0.3s ease-out forwards; opacity: 0; pointer-events: auto;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); color: #333; }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- MOBILE --- */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { max-width: 100%; }
            .calendar-header { display: none; }
            .calendar-grid { display: flex; flex-direction: column; gap: 0; background: transparent; border: none; }
            
            .day-cell.hidden-mobile { display: none !important; }

            .day-cell {
                min-height: 60px; border-bottom: 1px solid var(--border);
                flex-direction: row; align-items: center; padding: 12px 5px;
            }
            .day-cell.empty { display: none; }

            .date-number {
                flex-direction: column-reverse; align-items: center; justify-content: center;
                width: 50px; min-width: 50px; margin-bottom: 0; background: #f1f5f9;
                border-radius: 8px; padding: 6px 0; margin-right: 12px; height: 44px;
            }
            .day-weekday { display: block; font-size: 0.65rem; text-transform: uppercase; color: var(--text-sub); line-height: 1; }
            
            .day-cell.today .date-number { background: var(--primary); color: white; }
            .day-cell.today .day-weekday { color: rgba(255,255,255,0.8); }

            .expense-chips { flex-direction: row; flex-wrap: wrap; gap: 6px; align-content: center; }
            
            /* Mobile specific chip override to handle truncation safely */
            .expense-chip { 
                background: #f1f5f9; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;
                max-width: 140px; /* Force truncation on mobile */
            }
            
            .balance-indicator { margin-top: 0; font-size: 0.95rem; min-width: 70px; }
            
            .pending-actions { flex-direction: column; align-items: stretch; }
            .schedule-row { justify-content: center; margin-top: 5px; }

            #historyToggleContainer { display: block; }
        }

        @media (min-width: 601px) {
            #historyToggleContainer { display: none !important; }
            .day-cell.hidden-mobile { display: flex !important; opacity: 0.4; background: #f8fafc; }
        }

        /* --- MODALS --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 2000;
            backdrop-filter: blur(2px);
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; padding: 25px; border-radius: 16px;
            width: 90%; max-width: 450px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column;
        }

        /* Custom Confirm Modal */
        #confirmModal { z-index: 3000; } 
        #confirmModal .modal-content { max-width: 350px; text-align: center; }
        .confirm-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
        .confirm-actions button { min-width: 80px; }

        .expense-list-item {
            padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: background 0.2s;
        }
        .expense-list-item:hover { background: #f8fafc; }
        .expense-list-item.editing { background: #fffbeb; border-left: 4px solid var(--warning); }
        
        .email-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9rem;
        }

        /* Queue List Styling */
        .queue-item {
            display: flex; gap: 10px; align-items: center; background: #fff; border: 1px solid #e2e8f0;
            margin-bottom: 8px; padding: 10px; border-radius: 8px;
        }
        .queue-item.unscheduled { border-left: 4px solid var(--warning); }
        
        .queue-details { flex-grow: 1; }
        .queue-cost { font-weight: bold; text-align:right;}
        .queue-projection { font-size:0.75rem; color:var(--success); font-weight:600; display:block; margin-top:2px; }
        
        .queue-controls { display: flex; flex-direction: column; gap: 2px; }
        .queue-arrow { 
            border: 1px solid #ddd; background: #f8fafc; width: 24px; height: 24px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 4px;
            font-size: 0.8rem;
        }
        .queue-arrow:hover { background: #e2e8f0; }

        /* --- LOGIN --- */
        #loginPrompt {
            background: white; padding: 30px; border-radius: 16px; text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); max-width: 400px; margin: 40px auto;
        }
        .login-input { width: 100%; margin-bottom: 12px; padding: 12px; }
        .auth-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .auth-actions button { width: 100%; }
        
        #appContent { display: none; }
    </style>
</head>
<body>

    <div id="loadingOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center;">
        Loading PaceBudget...
    </div>

    <div id="toast-container"></div>

    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h3 id="confirmTitle" style="margin-top:0;">Confirm</h3>
            <p id="confirmMessage" style="color:var(--text-sub);">Are you sure?</p>
            <div class="confirm-actions">
                <button class="btn-outline" onclick="closeConfirm()">Cancel</button>
                <button id="confirmYesBtn">Yes</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <h1 style="margin:0; font-size:1.2rem; font-weight:800; color:var(--primary);">PaceBudget</h1>
                <button class="btn-text" onclick="openHelp()" style="font-size:1.1rem; width:30px; height:30px; border-radius:50%; border:1px solid #ccc; display:flex; align-items:center; justify-content:center;">?</button>
            </div>
            <div id="userDisplay" style="display:none;" class="user-area">
                <span id="headerUserName" class="user-name-display"></span>
                <div class="profile-btn" onclick="openSettings()">ðŸ‘¤</div>
            </div>
        </header>

        <div id="loginPrompt" style="display:none;">
            <h2 style="margin-top:0;">Family Login</h2>
            <p style="color:var(--text-sub); margin-bottom:20px;">Shared budget access.</p>
            <form onsubmit="handleLogin(event)">
                <input type="email" id="loginEmail" class="login-input" placeholder="Email" required>
                <input type="password" id="loginPass" class="login-input" placeholder="Password" required>
                <div class="auth-actions">
                    <button type="submit">Log In</button>
                    <button type="button" class="btn-outline" onclick="toggleRegisterMode()">Create Account</button>
                </div>
            </form>
        </div>

        <div id="appContent">
            <div class="controls">
                <div class="month-nav">
                    <button class="btn-text" onclick="changeMonth(-1)">â—€</button>
                    <h2 id="currentMonthLabel">Month Year</h2>
                    <button class="btn-text" onclick="changeMonth(1)">â–¶</button>
                    <span class="jump-today" onclick="jumpToToday()">Today</span>
                </div>
                
                <div class="budget-row" style="justify-content:center; margin-top:5px;">
                    <div class="month-summary">
                        In: <span id="totalIncome" style="color:var(--success); font-weight:700;">$0</span>
                    </div>
                    <div class="month-summary">
                        Out: <span id="totalExpenses" style="color:var(--text-main); font-weight:700;">$0</span>
                    </div>
                    <div class="month-summary">
                        Rem: <span id="budgetRem" style="font-weight:700;">$0</span>
                    </div>
                </div>

                <div class="top-actions" style="justify-content:center; margin-top:10px;">
                    <button onclick="toggleInbox()" class="btn-outline btn-sm">
                        ðŸ“¥ Inbox <span id="inboxCountBadge" style="background:var(--danger); color:white; font-size:0.7rem; padding:2px 6px; border-radius:10px; margin-left:5px; display:none;">0</span>
                    </button>
                    <button onclick="openAddModal()" class="btn-sm">+ Add Item</button>
                </div>
            </div>

            <div id="pendingDrawer" class="pending-drawer">
                <div class="pending-input-area">
                    <div class="pending-top">
                        <span>Inbox Item</span>
                        <button class="btn-text" onclick="toggleInbox()">âœ•</button>
                    </div>
                    <div class="pending-row-main">
                        <input type="number" id="pendingAmount" placeholder="$" step="0.01">
                        <input type="text" id="pendingDesc" placeholder="Description (e.g. Groceries)">
                    </div>
                    <div class="link-row">
                        <input type="url" id="pendingLink" class="link-input" placeholder="https://...">
                        <button class="action-btn" onclick="addToPending()">Add to Inbox</button>
                    </div>
                </div>
                <div id="pendingList" class="pending-list">
                    </div>
            </div>

            <div id="historyToggleContainer">
                <button class="history-btn" onclick="toggleMobileHistory()">Show History</button>
            </div>

            <div class="calendar-header">
                <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
            </div>
            
            <div id="calendarGrid" class="calendar-grid">
                </div>
        </div>
    </div>

    <div class="modal" id="expenseModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Details</h3>
                <button class="btn-text" onclick="closeModal()">âœ•</button>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; color:var(--text-sub); font-size:0.85rem; margin-bottom:5px;">Amount</label>
                <input type="number" id="expenseAmount" step="0.01">
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; color:var(--text-sub); font-size:0.85rem; margin-bottom:5px;">Description</label>
                <input type="text" id="expenseDesc">
            </div>

            <div style="margin-bottom:15px;">
                <label style="display:block; color:var(--text-sub); font-size:0.85rem; margin-bottom:5px;">Date</label>
                <input type="date" id="expenseDate">
            </div>

            <div style="margin-bottom:20px;">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="expenseIsIncome">
                    <span>This is Income</span>
                </label>
            </div>

            <div style="display:flex; justify-content:space-between; gap:10px;">
                <button class="btn-danger-outline" onclick="deleteCurrentItem()">Delete</button>
                <button onclick="saveExpenseItem()" id="saveBtn">Save Item</button>
            </div>
        </div>
    </div>

    <div class="modal" id="dayModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="dayModalTitle" style="margin:0;">Date</h3>
                <button class="btn-text" onclick="closeDayModal()">âœ•</button>
            </div>
            <div id="dayListContent" style="display:flex; flex-direction:column; gap:5px;">
                </div>
            <button class="btn-outline" style="width:100%; margin-top:15px;" onclick="openAddModalForDay()">+ Add to this day</button>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Settings</h3>
                <button class="btn-text" onclick="closeSettings()">âœ•</button>
            </div>
            <p>User: <span id="settingsEmail"></span></p>
            <button class="btn-outline" onclick="window.exportData()">Export JSON Backup</button>
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                <button class="btn-danger-outline" onclick="handleLogout()">Log Out</button>
            </div>
        </div>
    </div>

<script>
    // --- STATE MANAGEMENT ---
    let appData = {
        expenses: [],
        pending: []
    };
    
    let currentDate = new Date();
    let currentEditId = null;
    let selectedDayDate = null;
    let currentUser = null;

    // --- INIT ---
    window.onload = () => {
        // Simulate checking auth or local storage
        const savedData = localStorage.getItem('paceBudget_data');
        if(savedData) {
            appData = JSON.parse(savedData);
        }
        
        const savedUser = localStorage.getItem('paceBudget_user');
        if(savedUser) {
            currentUser = JSON.parse(savedUser);
            showApp();
        } else {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('loginPrompt').style.display = 'block';
        }
    };

    function showApp() {
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('loginPrompt').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        document.getElementById('userDisplay').style.display = 'flex';
        document.getElementById('headerUserName').textContent = currentUser.email.split('@')[0];
        renderCalendar();
        updateInboxCount();
    }

    // --- AUTH MOCKUP ---
    window.handleLogin = (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        if(email) {
            currentUser = { email: email };
            localStorage.setItem('paceBudget_user', JSON.stringify(currentUser));
            showApp();
        }
    };

    window.handleLogout = () => {
        localStorage.removeItem('paceBudget_user');
        location.reload();
    };

    window.toggleRegisterMode = () => {
        alert("Registration is open. Just log in with any email/password to start a local session.");
    };

    // --- DATA HANDLING ---
    function saveData() {
        localStorage.setItem('paceBudget_data', JSON.stringify(appData));
        renderCalendar();
        updateInboxCount();
    }

    function generateId() {
        return '_' + Math.random().toString(36).substr(2, 9);
    }

    // --- CALENDAR LOGIC ---
    window.changeMonth = (delta) => {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    };

    window.jumpToToday = () => {
        currentDate = new Date();
        renderCalendar();
    };

    window.renderCalendar = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        document.getElementById('currentMonthLabel').textContent = firstDay.toLocaleDateString('default', { month: 'long', year: 'numeric' });
        
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        
        // Month stats
        let income = 0;
        let expense = 0;

        // Fill empty days
        for(let i=0; i<firstDay.getDay(); i++) {
            const empty = document.createElement('div');
            empty.className = 'day-cell empty';
            grid.appendChild(empty);
        }

        // Fill actual days
        for(let d=1; d<=lastDay.getDate(); d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            
            // Check if today
            const todayStr = new Date().toISOString().split('T')[0];
            if(dateStr === todayStr) cell.classList.add('today');

            // Find items
            const dayItems = appData.expenses.filter(e => e.date === dateStr);
            
            // Calculate Day Total
            let dayTotal = 0;
            dayItems.forEach(item => {
                if(item.isIncome) {
                    income += parseFloat(item.amount);
                    dayTotal += parseFloat(item.amount);
                } else {
                    expense += parseFloat(item.amount);
                    dayTotal -= parseFloat(item.amount);
                }
            });

            // HTML Structure
            let chipsHtml = '';
            dayItems.forEach(item => {
                const isInc = item.isIncome;
                // NO ICONS: Just text
                chipsHtml += `
                    <div class="expense-chip" style="${isInc ? 'color:var(--success);' : ''}">
                        <span style="font-weight:600;">$${parseFloat(item.amount).toFixed(0)}</span>
                        <span class="chip-desc-text">${item.desc}</span>
                    </div>
                `;
            });

            cell.innerHTML = `
                <div class="date-number">
                    <span>${d}</span>
                    <span class="day-weekday">${new Date(year, month, d).toLocaleDateString('en-US', {weekday:'short'})}</span>
                </div>
                <div class="expense-chips">
                    ${chipsHtml}
                </div>
                <div class="balance-indicator ${dayTotal >= 0 ? 'bal-pos' : 'bal-neg'}">
                    ${dayTotal !== 0 ? (dayTotal>0?'+':'-') + '$' + Math.abs(dayTotal).toFixed(0) : ''}
                </div>
            `;
            
            cell.onclick = () => openDayModal(dateStr);
            grid.appendChild(cell);
        }

        document.getElementById('totalIncome').textContent = '$' + income.toFixed(2);
        document.getElementById('totalExpenses').textContent = '$' + expense.toFixed(2);
        document.getElementById('budgetRem').textContent = '$' + (income - expense).toFixed(2);
        document.getElementById('budgetRem').style.color = (income - expense) >= 0 ? 'var(--success)' : 'var(--danger)';
    };

    // --- MODALS ---
    window.openAddModal = () => {
        currentEditId = null;
        document.getElementById('expenseAmount').value = '';
        document.getElementById('expenseDesc').value = '';
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('expenseIsIncome').checked = false;
        document.getElementById('saveBtn').textContent = "Add Item";
        document.getElementById('expenseModal').classList.add('active');
    };

    window.openAddModalForDay = () => {
        if(selectedDayDate) {
            openAddModal();
            document.getElementById('expenseDate').value = selectedDayDate;
            document.getElementById('dayModal').classList.remove('active');
        }
    };

    window.closeModal = () => {
        document.getElementById('expenseModal').classList.remove('active');
    };

    window.saveExpenseItem = () => {
        const amt = document.getElementById('expenseAmount').value;
        const desc = document.getElementById('expenseDesc').value;
        const date = document.getElementById('expenseDate').value;
        const isIncome = document.getElementById('expenseIsIncome').checked;

        if(!amt || !desc || !date) {
            window.showToast("Please fill all fields", "warning");
            return;
        }

        if(currentEditId) {
            // Edit existing
            const idx = appData.expenses.findIndex(e => e.id === currentEditId);
            if(idx > -1) {
                appData.expenses[idx] = {
                    id: currentEditId,
                    amount: parseFloat(amt),
                    desc: desc,
                    date: date,
                    isIncome: isIncome
                };
                window.showToast("Updated", "success");
            }
        } else {
            // Add new
            appData.expenses.push({
                id: generateId(),
                amount: parseFloat(amt),
                desc: desc, // Pure text, no icon logic
                date: date,
                isIncome: isIncome
            });
            window.showToast("Added", "success");
        }
        
        saveData();
        closeModal();
    };

    window.deleteCurrentItem = () => {
        if(!currentEditId) return;
        if(confirm("Delete this item?")) {
            appData.expenses = appData.expenses.filter(e => e.id !== currentEditId);
            saveData();
            closeModal();
            window.showToast("Deleted", "error");
        }
    };

    // --- DAY DETAIL MODAL ---
    window.openDayModal = (dateStr) => {
        selectedDayDate = dateStr;
        document.getElementById('dayModalTitle').textContent = new Date(dateStr + 'T00:00:00').toLocaleDateString('default', { weekday: 'long', month: 'long', day: 'numeric' });
        
        const list = document.getElementById('dayListContent');
        list.innerHTML = '';
        
        const items = appData.expenses.filter(e => e.date === dateStr);
        if(items.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sub);">No items this day.</div>';
        } else {
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'expense-list-item';
                // NO ICON displayed here either
                el.innerHTML = `
                    <div style="font-weight:500;">${item.desc}</div>
                    <div style="font-weight:700; color:${item.isIncome ? 'var(--success)' : 'var(--danger)'}">
                        ${item.isIncome ? '+' : '-'}$${parseFloat(item.amount).toFixed(2)}
                    </div>
                `;
                el.onclick = () => {
                    editItem(item);
                };
                list.appendChild(el);
            });
        }
        document.getElementById('dayModal').classList.add('active');
    };

    window.closeDayModal = () => {
        document.getElementById('dayModal').classList.remove('active');
    };

    function editItem(item) {
        currentEditId = item.id;
        document.getElementById('expenseAmount').value = item.amount;
        document.getElementById('expenseDesc').value = item.desc;
        document.getElementById('expenseDate').value = item.date;
        document.getElementById('expenseIsIncome').checked = item.isIncome;
        document.getElementById('saveBtn').textContent = "Update Item";
        document.getElementById('dayModal').classList.remove('active');
        document.getElementById('expenseModal').classList.add('active');
    }

    // --- INBOX / PENDING LOGIC ---
    window.toggleInbox = () => {
        const d = document.getElementById('pendingDrawer');
        d.classList.toggle('open');
        renderInboxList();
    };

    function updateInboxCount() {
        const c = appData.pending.length;
        const b = document.getElementById('inboxCountBadge');
        b.textContent = c;
        b.style.display = c > 0 ? 'inline-block' : 'none';
    }

    window.addToPending = () => {
        const amt = document.getElementById('pendingAmount').value;
        const desc = document.getElementById('pendingDesc').value;
        const link = document.getElementById('pendingLink').value;
        
        if(!desc) return;
        
        appData.pending.push({
            id: generateId(),
            amount: amt || 0,
            desc: desc,
            link: link
        });
        
        document.getElementById('pendingAmount').value = '';
        document.getElementById('pendingDesc').value = '';
        document.getElementById('pendingLink').value = '';
        
        saveData();
        renderInboxList();
        window.showToast("Added to Inbox", "success");
    };

    function renderInboxList() {
        const list = document.getElementById('pendingList');
        list.innerHTML = '';
        
        appData.pending.forEach(item => {
            const el = document.createElement('div');
            el.className = 'pending-item';
            el.innerHTML = `
                <div style="display:flex; justify-content:space-between; font-weight:600;">
                    <span>${item.desc}</span>
                    <span>$${item.amount}</span>
                </div>
                ${item.link ? `<a href="${item.link}" target="_blank" style="font-size:0.8rem; color:var(--primary); text-overflow:ellipsis; overflow:hidden; white-space:nowrap;">Link</a>` : ''}
                <div class="pending-actions">
                    <button class="action-btn" onclick="schedulePending('${item.id}')">ðŸ“… Schedule</button>
                    <button class="action-btn" style="color:var(--danger); border-color:var(--danger);" onclick="deletePending('${item.id}')">ðŸ—‘</button>
                </div>
            `;
            list.appendChild(el);
        });
    }

    window.schedulePending = (id) => {
        const item = appData.pending.find(p => p.id === id);
        if(item) {
            // Move to main modal to schedule
            currentEditId = null; // New item effectively
            document.getElementById('expenseAmount').value = item.amount;
            document.getElementById('expenseDesc').value = item.desc;
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            
            // Remove from pending
            deletePending(id, false);
            
            closeModal(); // Close any other
            document.getElementById('pendingDrawer').classList.remove('open');
            document.getElementById('expenseModal').classList.add('active');
        }
    };

    window.deletePending = (id, notify=true) => {
        appData.pending = appData.pending.filter(p => p.id !== id);
        saveData();
        renderInboxList();
        if(notify) window.showToast("Removed from Inbox", "neutral");
    };

    // --- SETTINGS ---
    window.openSettings = () => {
        document.getElementById('settingsEmail').textContent = currentUser ? currentUser.email : '';
        document.getElementById('settingsModal').classList.add('active');
    };
    
    window.closeSettings = () => document.getElementById('settingsModal').classList.remove('active');

    window.openHelp = () => {
        alert("PaceBudget Help:\n\n1. Use the Calendar to view daily spending.\n2. Click 'Add Item' to record expenses.\n3. Use 'Inbox' to store unscheduled bills.\n\nIcons have been removed for a cleaner look.");
    };

    window.exportData = () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "pacebudget_backup_" + new Date().toISOString().split('T')[0] + ".json");
        document.body.appendChild(downloadAnchorNode); 
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        window.showToast("Data export started!", "success");
    };

    // --- UTILS ---
    window.showToast = (msg, type = 'neutral') => {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerHTML = msg;
        container.appendChild(el);
        setTimeout(() => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(10px)';
            el.style.transition = 'all 0.3s';
            setTimeout(() => el.remove(), 300);
        }, 3000);
    };

    // Mobile specific: Confirm modal wrapper
    window.closeConfirm = () => {
        document.getElementById('confirmModal').style.display = 'none';
    };
</script>
</body>
</html>